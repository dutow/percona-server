################################################################################
# InnoDB transparent tablespace data encryption for mysql.tablespace.
# For mysql.tablespace, this test will test
#    1 - Alter mysql.tablespace with
#        - and without loading keyring plugin
#        - valid/invalid encryption option
#        -ENCRYPTION='n' to ENCRYPTION='y'
#    2 - Actual encryption taking place or not
#    3 - Create/Alter table using mysql.tablespace
#    4 - Alter table part of innodb_file_per_table/general/innodb_system/mysql ts to mysql ts
#    5 - Create view using mysql.tablespace
#    6 - Delete/truncate/drop DD table part of mysql tablespace
#    7 - Changing encryption attribute of tables in mysql tablespace
#    8 - Restart with same keyring plugin option and access mysql tables
#    9 - Restart without keyring plugin option, Install plugin explicitly and alter encryption to Y
#   10 - Monitor progress of encryption in performance_schema table
#   11 - Rename/drop mysql tablespace
#   12 - Create tablespace with name as mysql
################################################################################

--source include/big_test.inc
--source include/have_debug.inc
# Disable in valgrind because of timeout, cf. Bug#22760145
--source include/not_valgrind.inc
--disable_query_log
call mtr.add_suppression("\\[ERROR\\] \\[[^]]*\\] \\[[^]]*\\] Check keyring fail, please check the keyring is loaded.");
call mtr.add_suppression("\\[ERROR\\].*Plugin keyring_file reported: 'keyring_file initialization failure.");
call mtr.add_suppression("\\[ERROR\\].*Plugin keyring_file reported: 'File .*keyring' not found .*");
call mtr.add_suppression("\\[ERROR\\] \\[[^]]*\\] \\[[^]]*\\] Encryption can't find master key, please check the keyring is loaded.");
--enable_query_log


--echo #########################################################################
--echo # Restart with keyring plugin
--echo #   - monitor progress of encryption in performance_schema table
--echo #########################################################################
let $restart_parameters = restart: --early-plugin-load="keyring_file=$KEYRING_PLUGIN" --loose-keyring_file_data=$MYSQL_TMP_DIR/mysql_ts_keyring $KEYRING_PLUGIN_OPT;
--source include/restart_mysqld_no_echo.inc
ALTER TABLESPACE mysql ENCRYPTION='N';
--sleep 6
SELECT NAME, ENCRYPTION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES where NAME='mysql';
--echo # Set Encryption process to wait after page 5 so that we can monitor
--echo # progress in performance_schema table
SET DEBUG_SYNC = 'alter_encrypt_tablespace_wait_after_page0 SIGNAL s1 WAIT_FOR s2';

let $con_default_thread_id= `select THREAD_ID from performance_schema.threads
                                where PROCESSLIST_ID = connection_id()`;

--send
ALTER TABLESPACE mysql ENCRYPTION='Y';

--echo # Monitoring connection
connect(con1, localhost, root,,);
--connection con1


--sleep 10

#use mysql;

# Do something
CREATE TABLE t1 (id INT) ENCRYPTION='Y';
INSERT INTO t1 VALUES (1);
INSERT INTO t1 VALUES (2);

--sleep 3

--source include/kill_mysqld.inc

--echo # Default connection
--connection default
--error 2013
--reap

--source include/start_mysqld.inc

--echo ###########
--echo # Cleanup #
--echo ###########
--disconnect con1
 # Unencrypt tablespace
ALTER TABLESPACE mysql ENCRYPTION='N';
SELECT NAME, ENCRYPTION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME='mysql';

remove_file $MYSQL_TMP_DIR/mydummy_key;
remove_file $MYSQL_TMP_DIR/mysql_ts_keyring;
remove_file $MYSQLTEST_VARDIR/tmpfile.txt;

--echo #########################################################################
--echo # RESTART : WITHOUT KEYRING PLUGIN
--echo #########################################################################
let $restart_parameters = restart: ;
--source include/restart_mysqld.inc

